<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNICELL Servicio Técnico | App de Gestión</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================================================================== */
        /* Estilos base de UNICELL + Nuevos Temas */
        /* ================================================================== */
        
        body { 
            background-image: radial-gradient(at top left, var(--color-primary-gradient), transparent 50%), radial-gradient(at bottom right, var(--color-secondary-gradient), transparent 50%); 
            min-height: 100vh; 
            padding-top: 5rem; /* Compensar header fijo */
        }
        
        .accent-text { color: var(--accent-color); }

        .input-dark { 
            background-color: var(--bg-secondary); 
            border: 1px solid var(--border-color);
            color: var(--text-primary); 
        }
        .focus\:ring-primary:focus {
            --tw-ring-color: var(--accent-color) !important;
        }

        #logo-upload-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.7); opacity: 0; transition: opacity 0.3s; cursor: pointer; border-radius: 9999px; }
        
        #logo-container.admin-active:hover #logo-upload-overlay { display: flex; opacity: 1; }
        #logo-container:not(.admin-active) #logo-upload-overlay { display: none; }
        
        .inventory-image-preview { width: 100%; height: 160px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        
        .theme-btn { width: 2rem; height: 2rem; border-radius: 9999px; border: 3px solid #4B5563; cursor: pointer; transition: border-color 0.2s; }
        .theme-btn.active, .theme-btn:hover { border-color: var(--accent-color); }
        
        #theme-btn-dark { background-color: #818cf8; }
        #theme-btn-infernal { background-color: #ff4500; }
        #theme-btn-gold { background-color: #D4AF37; }

        /* ================================================== */
        /* INICIO: TUS NUEVOS ESTILOS DE TEMA */
        /* ================================================== */
        
        /********************************/
        /* Estilos Base (Comunes a todos los temas) */
        /********************************/
        html { height: 100%; }
        body { min-height: 100vh; display: flex; flex-direction: column; transition: background-color 0.5s ease; }
        .max-w-6xl.mx-auto { flex-grow: 1; }
        .product-card, .tool-card { transition: transform 0.2s, box-shadow 0.3s; }
        .product-card:hover, .tool-card:hover { transform: translateY(-5px); }
        #logo-upload { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; border: 0; }

        .skeleton-card { background-color: transparent; border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; }
        .skeleton-line { background-color: var(--bg-secondary); opacity: 0.7; border-radius: 0.25rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .4; } }

        /********************************/
        /* TEMA 1: Dark (Predeterminado) */
        /********************************/
        .theme-dark {
            --bg-primary: #1f2937; --bg-secondary: #374151; --bg-header: rgba(31, 41, 55, 0.8);
            --text-primary: #e5e7eb; --text-secondary: #d1d5db; --text-muted: #9ca3af;
            --border-color: #4b5563; --accent-color: #818cf8; --accent-color-dark: #6366f1;
            --font-main: 'Poppins', sans-serif; --font-headings: 'Poppins', sans-serif;
            --color-primary-gradient: rgba(129, 140, 248, 0.1); --color-secondary-gradient: rgba(99, 102, 241, 0.1);
        }

        /********************************/
        /* TEMA 2: Fuego Infernal */
        /********************************/
        .theme-infernal {
            --bg-primary: #000000; --bg-secondary: #2d1a1a; --bg-header: rgba(17, 7, 0, 0.6);
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-muted: #9ca3af;
            --border-color: #571e1e; --accent-color: #ff4500; --accent-color-dark: #e63e00;
            --font-main: 'Roboto', sans-serif; --font-headings: 'Roboto', sans-serif;
            --color-primary-gradient: rgba(255, 69, 0, 0.1); --color-secondary-gradient: rgba(230, 62, 0, 0.1);
        }
        .theme-infernal { background-image: linear-gradient(180deg, #1a0000 0%, #000000 100%); }
        .theme-infernal .product-card:hover, .theme-infernal .tool-card:hover { box-shadow: 0 0 25px rgba(255, 69, 0, 0.5); border-color: rgba(255, 69, 0, 0.7); }

        /********************************/
        /* TEMA 3: Luxury Gold */
        /********************************/
        .theme-gold {
            --bg-primary: #121212; --bg-secondary: #2b2b2b; --bg-header: rgba(18, 18, 18, 0.85);
            --text-primary: #f1f1f1; --text-secondary: #cccccc; --text-muted: #a0a0a0;
            --border-color: #444444; --accent-color: #D4AF37; --accent-color-dark: #B8860B;
            --font-main: 'Poppins', sans-serif; --font-headings: 'Playfair Display', serif;
            --color-primary-gradient: rgba(212, 175, 55, 0.05); --color-secondary-gradient: rgba(184, 134, 11, 0.05);
        }
        .theme-gold { background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); }
        .theme-gold .product-card:hover, .theme-gold .tool-card:hover { box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2); border-color: var(--accent-color); }
        .theme-gold .bg-indigo-500, .theme-gold .hover\:bg-indigo-600:hover { background: linear-gradient(145deg, #D4AF37, #B8860B); color: #121212; }
        .theme-gold .text-indigo-400, .theme-gold .text-indigo-300 { text-shadow: 0 0 8px #D4AF3788; }


        /********************************/
        /* Aplicación de Variables CSS */
        /********************************/
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-main); }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-headings); }

        header.sticky { background-color: var(--bg-header); border-bottom: 1px solid var(--border-color); backdrop-filter: blur(10px); }

        .bg-gray-800 { background-color: var(--bg-secondary) !important; }
        .bg-gray-900 { background-color: var(--bg-primary) !important; }
        .text-gray-300 { color: var(--text-secondary); }
        .text-gray-400 { color: var(--text-muted); }
        .bg-gray-600 { background-color: var(--bg-secondary) !important; }
        .bg-gray-700 { background-color: color-mix(in srgb, var(--bg-secondary) 70%, var(--bg-primary)) !important; }
        
        .border-gray-500, .border-gray-600, .border-gray-700 { border-color: var(--border-color); }

        /* Acentos */
        .text-indigo-400, .text-indigo-300 { color: var(--accent-color); }
        .border-indigo-500 { border-color: var(--accent-color); }
        .bg-indigo-500 { background-color: var(--accent-color-dark); color: var(--text-primary); }
        .hover\:bg-indigo-600:hover { background-color: var(--accent-color); }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--accent-color); }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 1px var(--accent-color); outline: none; }
        
        /* Mapeo de colores UNICELL */
        .bg-pink-600 { background-color: var(--accent-color-dark) !important; }
        .hover\:bg-pink-700:hover { background-color: var(--accent-color) !important; }
        .border-pink-500\/50 { border-color: color-mix(in srgb, var(--accent-color) 50%, transparent) !important; }
        .text-pink-500 { color: var(--accent-color) !important; }
        .file\:text-pink-700 { color: var(--accent-color-dark) !important; }
        .file\:bg-pink-50 { background-color: color-mix(in srgb, var(--accent-color) 10%, transparent) !important; }
        .hover\:file\:bg-pink-100:hover { background-color: color-mix(in srgb, var(--accent-color) 20%, transparent) !important; }
        
        /* Colores Fijos */
        .bg-green-600 { background-color: #16a34a !important; }
        .hover\:bg-green-700:hover { background-color: #15803d !important; }
        .shadow-green-700\/50 { box-shadow: 0 10px 15px -3px rgba(21, 128, 61, 0.5), 0 4px 6px -2px rgba(21, 128, 61, 0.5) !important; }
        .bg-red-600 { background-color: #dc2626 !important; }
        .hover\:bg-red-700:hover { background-color: #b91c1c !important; }
        .text-red-500 { color: #ef4444 !important; }
        .text-red-400 { color: #f87171 !important; }
        .text-yellow-400 { color: #facc15 !important; }
        .hover\:text-yellow-300:hover { color: #fde047 !important; }
        .text-green-500 { color: #22c55e !important; }

        /* ESTADOS DE VENTA */
        .status-paid { background-color: #16a34a !important; color: #ffffff !important; border-color: #15803d !important; }
        .status-pending { background-color: #f59e0b !important; color: #1f2937 !important; border-color: #d97706 !important; }
        .status-returned { background-color: #dc2626 !important; color: #ffffff !important; border-color: #b91c1c !important; }
        
        /* ================================================== */
        /* FIN: NUEVOS ESTILOS DE TEMA */
        /* ================================================== */
    </style>
</head>
<body class="theme-dark">

    <header class="sticky top-0 z-10 shadow-lg p-4 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="relative" id="logo-container">
                <div class="relative w-12 h-12 flex items-center justify-center rounded-full border-2 border-indigo-500 shadow-md bg-gray-700" id="current-logo"> 
                     <svg id="default-logo-svg" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 accent-text" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" opacity=".2"/>
                        <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z" fill="var(--accent-color)"/>
                        <path d="M16 10a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM10 10a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        <path d="M12 14v-2" stroke-width="3"/>
                    </svg>
                    <div id="logo-upload-overlay"> <i data-lucide="upload" class="w-5 h-5 text-white"></i>
                        <input type="file" id="logo-file-input" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
                    </div>
                </div>
            </div>
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-white">
                UNICELL
                <span class="block text-sm sm:text-base font-light accent-text border-b border-indigo-500 inline-block pb-0">
                    SERVICIO TÉCNICO
                </span>
            </h1>
        </div>
        
        <div class="flex items-center space-x-3">
            <button id="open-inventory-modal-btn" class="bg-indigo-500 text-white font-medium py-1.5 px-3 rounded-lg text-sm shadow-md transition duration-300 flex items-center">
                <i data-lucide="package" class="w-4 h-4 mr-1"></i> Inventario
            </button>
            <button id="open-sales-modal-btn" class="bg-transparent text-gray-300 font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 hover:text-white transition duration-300 text-sm hidden flex items-center">
                <i data-lucide="receipt-text" class="w-4 h-4 mr-1"></i> Ventas
            </button>

            <div class="relative" id="theme-dropdown-wrapper">
                <button id="open-theme-dropdown-btn" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full transition duration-300 shadow-md flex items-center">
                    <i data-lucide="palette" class="w-5 h-5"></i>
                </button>
                <div id="theme-dropdown-menu" class="hidden absolute top-full right-0 mt-2 w-max bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-3 z-50">
                    <div id="theme-selector-container" class="flex space-x-2 items-center">
                        <button id="theme-btn-dark" class="theme-btn" title="Tema Oscuro"></button>
                        <button id="theme-btn-infernal" class="theme-btn" title="Tema Infernal"></button>
                        <button id="theme-btn-gold" class="theme-btn" title="Tema Dorado"></button>
                    </div>
                </div>
            </div>

            <button id="open-auth-modal-btn" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full transition duration-300 shadow-md flex items-center">
                <i data-lucide="user" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-8"> 
        <section class="text-center mb-16 mt-8">
            <p id="app-error-display" class="mt-4 text-red-500 font-bold hidden"></p>
            <p class="mt-4 text-gray-400 max-w-md mx-auto">
                Especialistas en la reparación de dispositivos móviles y mantenimiento de consolas.
            </p>
        </section>

        <section id="contacto" class="mb-12 text-center p-6 bg-gray-800 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-6 text-white">Contáctanos Hoy Mismo</h2>
            <p class="text-gray-300 mb-8">¡Agenda tu reparación o consulta sin compromiso!</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                <a href="https://wa.me/52177191068" target="_blank" class="flex items-center space-x-3 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full transition duration-300 shadow-md shadow-green-700/50">
                    <i data-lucide="phone" class="w-5 h-5"></i>
                    <span>77191068 (WhatsApp)</span>
                </a>
            </div>
        </section>

        <footer class="text-center mt-10 text-gray-500 border-t border-gray-700 pt-6">
            <p>&copy; 2024 UNICELL Servicio Técnico. Todos los derechos reservados.</p>
            <p id="admin-status" class="text-xs mt-2 italic hidden">
                <span class="text-green-500">MODO ADMINISTRADOR ACTIVO.</span>
            </p>
        </footer>
    </div>

    <div id="auth-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl shadow-2xl border-2 border-gray-700 max-w-sm w-full p-6 relative">
            <button id="close-auth-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition"> <i data-lucide="x" class="w-6 h-6"></i> </button>
            <div id="auth-container">
                <h2 class="text-2xl font-bold text-center mb-6 text-white" id="auth-title">Iniciar Sesión</h2>
                <form id="login-form" class="space-y-4">
                    <input id="auth-email" type="email" placeholder="Correo Electrónico" class="w-full p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500" required />
                    <input id="auth-password" type="password" placeholder="Contraseña" class="w-full p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500" required />
                    <button type="submit" id="auth-submit-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition duration-300 flex items-center justify-center"> <i data-lucide="log-in" class="w-5 h-5 mr-2"></i> <span id="auth-button-text">Iniciar Sesión</span> </button>
                    <p id="auth-message" class="text-center text-sm text-red-400"></p>
                </form>
                <button id="toggle-auth-mode" class="w-full mt-4 text-center text-sm text-gray-400 hover:text-white transition"> ¿No tienes cuenta? Regístrate </button>
            </div>
            <div id="logout-container" class="hidden text-center">
                <p class="text-lg text-white mb-4">Sesión Iniciada.</p>
                <p id="current-user-uid" class="text-xs text-gray-500 mb-6 font-mono break-all"></p>
                <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-300 flex items-center justify-center"> <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Cerrar Sesión </button>
            </div>
        </div>
    </div>

    <div id="inventory-modal" class="fixed inset-0 z-40 hidden bg-black bg-opacity-80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl shadow-2xl border-2 border-pink-500/50 max-w-6xl w-full max-h-[90vh] overflow-y-auto p-6 relative transform transition-all duration-300">
            <button id="close-inventory-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition"> <i data-lucide="x" class="w-7 h-7"></i> </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-white flex items-center justify-center"> <i data-lucide="package" class="w-7 h-7 accent-text mr-3"></i> Inventario de Productos </h2>
            <div id="inventory-content-admin" class="hidden mb-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Añadir/Editar Producto</h3>
                <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 items-end">
                    <div> <label class="text-gray-400 text-sm">Nombre</label> <input id="inventory-name" type="text" placeholder="Nombre del Producto" class="w-full p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500" /> </div>
                    <div> <label class="text-gray-400 text-sm">Precio</label> <input id="inventory-price" type="number" placeholder="Precio (Ej: 150.00)" class="w-full p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500" step="0.01" /> </div>
                    <div> <label class="text-gray-400 text-sm">Categoría</label> <select id="inventory-category" class="w-full p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500 h-[46px]"> <option value="">Seleccionar...</option> <option value="Placas de Carga">Placas de Carga</option> <option value="Placas">Placas</option> <option value="Botones">Botones</option> <option value="Jacks">Jacks</option> <option value="Vidrios">Vidrios</option> <option value="Cargadores">Cargadores</option> <option value="Privados">Privados</option> <option value="Hidrogel">Hidrogel</option> <option value="Otro">Otro</option> </select> </div>
                    <div> <label class="text-gray-400 text-sm">Foto (Opcional)</label> <input type="file" id="inventory-image-file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100" accept="image/*" /> </div>
                    <button id="inventory-add-btn" class="sm:col-span-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50"> <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Añadir Producto </button>
                </div>
                <p id="inventory-message" class="text-center text-sm mt-3 text-red-400"></p>
            </div>
            <div id="inventory-content-public">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 rounded-lg">
                        <thead class="bg-gray-700"> <tr> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-40">Foto</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Nombre</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Categoría</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-32">Precio</th> <th id="inventory-header-actions" class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider w-40 hidden">Acciones</th> </tr> </thead>
                        <tbody id="inventory-list" class="bg-gray-800 divide-y divide-gray-700"> <tr><td colspan="5" class="text-center py-4 text-gray-500 italic">Cargando inventario...</td></tr> </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="sales-modal" class="fixed inset-0 z-40 hidden bg-black bg-opacity-80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-gray-900 rounded-xl shadow-2xl border-2 border-pink-500/50 max-w-6xl w-full max-h-[90vh] overflow-y-auto p-6 relative transform transition-all duration-300">
            <button id="close-sales-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition"> <i data-lucide="x" class="w-7 h-7"></i> </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-white flex items-center justify-center"> <i data-lucide="receipt-text" class="w-7 h-7 accent-text mr-3"></i> Registro de Ventas </h2>
            <p id="sales-auth-message" class="text-center p-4 text-red-400 hidden">Debes iniciar sesión para ver o registrar ventas.</p>
            <div id="sales-content"> 
                <div id="sales-add-form-admin" class="hidden mb-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold mb-4 text-gray-200">Añadir Nuevo Artículo</h3>
                    <label class="text-gray-400 text-sm mb-1 block">Destinatario/Cliente</label> <input id="client-name" type="text" placeholder="Nombre del Destinatario" class="w-full p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500 mb-4" />
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <input id="product-name" type="text" placeholder="Nombre del Producto/Servicio" class="col-span-1 sm:col-span-1 p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500" />
                        <select id="sale-category" class="col-span-1 sm:col-span-1 p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500 h-[46px]"> <option value="">Seleccionar...</option> <option value="Placas de Carga">Placas de Carga</option> <option value="Placas">Placas</option> <option value="Botones">Botones</option> <option value="Jacks">Jacks</option> <option value="Vidrios">Vidrios</option> <option value="Cargadores">Cargadores</option> <option value="Privados">Privados</option> <option value="Hidrogel">Hidrogel</option> <option value="Otro">Otro</option> </select>
                        <input id="product-price" type="number" placeholder="Precio (Ej: 150.00)" class="col-span-1 sm:col-span-1 p-3 rounded-lg input-dark focus:ring-1 focus:ring-indigo-500" step="0.01" />
                        <button id="add-btn" class="col-span-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50"> <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Añadir a Venta </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 rounded-lg">
                        <thead class="bg-gray-700"> <tr> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-32">Destinatario</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Producto</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Categoría</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-32">Precio</th> <th id="sales-header-actions" class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider w-40 hidden">Acciones</th> </tr> </thead>
                        <tbody id="sales-list" class="bg-gray-800 divide-y divide-gray-700"> <tr><td colspan="5" class="text-center py-4 text-gray-500 italic">Cargando ventas...</td></tr> </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-gray-700 rounded-lg flex justify-between items-center font-bold text-white text-xl"> <span>TOTAL VENTA:</span> <span id="sales-total" class="accent-text text-2xl">$0.00</span> </div>
            </div>
        </div>
    </div>


    <script>
        lucide.createIcons();
    </script>

    <script type="module">
        // --- CONFIGURACIÓN Y VARIABLES GLOBALES ---
        const SUPABASE_URL = 'https://pavonviwyyjmdwwhxrzm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhdm9udml3eXlqbWR3d2h4cnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MTA2MzcsImV4cCI6MjA3NzE4NjYzN30.dWGKn3MWuVHvOivh608-ZIdfVGsekdpfLu7quc42HBk';
        const ADMIN_EMAIL_REAL = 'unicell2025@gmail.com';
        const ASSETS_BUCKET = 'public_assets';
        const CATEGORY_OPTIONS_HTML = `<option value="Placas de Carga">Placas de Carga</option><option value="Placas">Placas</option><option value="Botones">Botones</option><option value="Jacks">Jacks</option><option value="Vidrios">Vidrios</option><option value="Cargadores">Cargadores</option><option value="Privados">Privados</option><option value="Hidrogel">Hidrogel</option><option value="Otro">Otro</option>`;
        let supabase = null, userId = null, userEmail = null, isAdmin = false;
        let logoUploadOverlayHTML = '', defaultSvgHtml = '';

        // --- REFERENCIAS DOM ---
        const adminStatusDisplay = document.getElementById('admin-status');
        const appErrorDisplay = document.getElementById('app-error-display');
        const logoContainer = document.getElementById('logo-container');
        const authModal = document.getElementById('auth-modal');
        const authContainer = document.getElementById('auth-container');
        const logoutContainer = document.getElementById('logout-container');
        const authTitle = document.getElementById('auth-title');
        const authButtonText = document.getElementById('auth-button-text');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const loginForm = document.getElementById('login-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authMessage = document.getElementById('auth-message');
        const currentUserUidDisplay = document.getElementById('current-user-uid');
        const logoutBtn = document.getElementById('logout-btn');
        const openSalesModalBtn = document.getElementById('open-sales-modal-btn');
        const salesModal = document.getElementById('sales-modal');
        const salesContent = document.getElementById('sales-content');
        const salesAuthMessage = document.getElementById('sales-auth-message');
        const salesAddFormAdmin = document.getElementById('sales-add-form-admin');
        const salesList = document.getElementById('sales-list');
        const salesTotal = document.getElementById('sales-total');
        const clientNameInput = document.getElementById('client-name');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const saleCategorySelect = document.getElementById('sale-category');
        const addSaleBtn = document.getElementById('add-btn');
        const salesHeaderActions = document.getElementById('sales-header-actions');
        const inventoryModal = document.getElementById('inventory-modal');
        const inventoryContentAdmin = document.getElementById('inventory-content-admin');
        const inventoryList = document.getElementById('inventory-list');
        const inventoryNameInput = document.getElementById('inventory-name');
        const inventoryPriceInput = document.getElementById('inventory-price');
        const inventoryCategorySelect = document.getElementById('inventory-category');
        const inventoryImageFile = document.getElementById('inventory-image-file');
        const inventoryAddBtn = document.getElementById('inventory-add-btn');
        const inventoryMessage = document.getElementById('inventory-message');
        const inventoryHeaderActions = document.getElementById('inventory-header-actions');
        const themeBtnDark = document.getElementById('theme-btn-dark');
        const themeBtnInfernal = document.getElementById('theme-btn-infernal');
        const themeBtnGold = document.getElementById('theme-btn-gold');
        const openThemeDropdownBtn = document.getElementById('open-theme-dropdown-btn');
        const themeDropdownMenu = document.getElementById('theme-dropdown-menu');
        const themeDropdownWrapper = document.getElementById('theme-dropdown-wrapper');

        // --- UTILIDADES ---
        function initLogoTemplates() {
            const overlay = document.getElementById('logo-upload-overlay');
            const svg = document.getElementById('default-logo-svg');
            if (overlay) { logoUploadOverlayHTML = overlay.outerHTML; if(overlay.parentNode) overlay.remove(); }
            if (svg) { defaultSvgHtml = svg.outerHTML; }
            const currentLogoDiv = document.getElementById('current-logo');
            if (currentLogoDiv && !currentLogoDiv.querySelector('img') && defaultSvgHtml) {
                currentLogoDiv.innerHTML = defaultSvgHtml + (logoUploadOverlayHTML || '');
                if (logoUploadOverlayHTML) lucide.createIcons();
            }
        }
        function handleGlobalError(msg) { appErrorDisplay.textContent = `Error crítico: ${msg}`; appErrorDisplay.classList.remove('hidden'); }
        function displayMessage(msg, element, type = 'error') { element.textContent = msg; element.className = type === 'success' ? 'text-center text-sm text-green-400' : 'text-center text-sm text-red-400'; setTimeout(() => { element.textContent = ''; }, 5000); }
        function closeThemeDropdown() { if (themeDropdownMenu) themeDropdownMenu.classList.add('hidden'); }
        function updateUIBasedOnAuth() {
            if (isAdmin) {
                adminStatusDisplay.classList.remove('hidden'); logoContainer.classList.add('admin-active'); 
                inventoryContentAdmin.classList.remove('hidden'); inventoryHeaderActions.classList.remove('hidden'); 
                salesAddFormAdmin.classList.remove('hidden'); salesHeaderActions.classList.remove('hidden'); 
                openSalesModalBtn.classList.remove('hidden'); 
                openSalesModalBtn.classList.remove('bg-transparent', 'text-gray-300'); openSalesModalBtn.classList.add('bg-indigo-500', 'text-white');
            } else {
                adminStatusDisplay.classList.add('hidden'); logoContainer.classList.remove('admin-active'); 
                inventoryContentAdmin.classList.add('hidden'); inventoryHeaderActions.classList.add('hidden');
                salesAddFormAdmin.classList.add('hidden'); salesHeaderActions.classList.add('hidden');
                if (userId) {
                    openSalesModalBtn.classList.remove('hidden');
                    openSalesModalBtn.classList.remove('bg-indigo-500', 'text-white'); openSalesModalBtn.classList.add('bg-transparent', 'text-gray-300');
                } else { openSalesModalBtn.classList.add('hidden'); }
            }
            loadInventoryData();
            if (userId) loadSalesData();
        }

        // --- AUTENTICACIÓN ---
        function handleAuthChange(session) {
            console.log('HandleAuthChange Fired. Session:', session);
            if (session && session.user) {
                userId = session.user.id; userEmail = session.user.email; isAdmin = (userEmail === ADMIN_EMAIL_REAL);
                currentUserUidDisplay.textContent = userEmail; authContainer.classList.add('hidden'); logoutContainer.classList.remove('hidden');
                salesAuthMessage.classList.add('hidden'); salesContent.classList.remove('hidden');
            } else {
                userId = null; userEmail = null; isAdmin = false;
                authContainer.classList.remove('hidden'); logoutContainer.classList.add('hidden');
                salesAuthMessage.classList.remove('hidden'); salesContent.classList.add('hidden'); renderSales([]);
            }
            updateUIBasedOnAuth(); loadLogo();
        }
        async function handleAuthSubmit(e) { /* ... (Sin cambios) ... */
             e.preventDefault();
            const email = authEmailInput.value; const password = authPasswordInput.value;
            const isSigningUp = authTitle.textContent === 'Registrarse';
            authSubmitBtn.disabled = true; authMessage.textContent = 'Procesando...';
            let response;
            try {
                if (isSigningUp) { response = await supabase.auth.signUp({ email, password }); }
                else { response = await supabase.auth.signInWithPassword({ email, password }); }
                if (response.error) { displayMessage(response.error.message, authMessage, 'error'); }
                else { displayMessage('Éxito. Cerrando modal...', authMessage, 'success'); setTimeout(() => closeModal(authModal), 1000); }
            } catch (err) { displayMessage('Error de conexión.', authMessage, 'error'); console.error(err); }
            finally { authSubmitBtn.disabled = false; }
        }
        async function handleLogout() { /* ... (Sin cambios) ... */
             const { error } = await supabase.auth.signOut();
             if (error) console.error("Error al cerrar sesión:", error.message);
             closeModal(authModal);
        }

        // --- TEMAS ---
        function applyTheme(themeName) {
            document.body.classList.remove('theme-dark', 'theme-infernal', 'theme-gold');
            const buttons = { 'dark': themeBtnDark, 'infernal': themeBtnInfernal, 'gold': themeBtnGold };
            Object.values(buttons).forEach(btn => btn && btn.classList.remove('active'));
            if (themeName === 'infernal') { document.body.classList.add('theme-infernal'); if(themeBtnInfernal) themeBtnInfernal.classList.add('active'); } 
            else if (themeName === 'gold') { document.body.classList.add('theme-gold'); if(themeBtnGold) themeBtnGold.classList.add('active'); } 
            else { document.body.classList.add('theme-dark'); if(themeBtnDark) themeBtnDark.classList.add('active'); }
            localStorage.setItem('unicell-theme', themeName);
        }
        function loadSavedTheme() {
             const savedTheme = localStorage.getItem('unicell-theme') || 'dark'; applyTheme(savedTheme);
             if(themeBtnDark) themeBtnDark.onclick = () => { applyTheme('dark'); closeThemeDropdown(); };
             if(themeBtnInfernal) themeBtnInfernal.onclick = () => { applyTheme('infernal'); closeThemeDropdown(); };
             if(themeBtnGold) themeBtnGold.onclick = () => { applyTheme('gold'); closeThemeDropdown(); };
        }

        // --- STORAGE (LOGO E INVENTARIO) ---
        async function uploadFile(file, path) { /* ... (Sin cambios) ... */ 
             const { data, error } = await supabase.storage.from(ASSETS_BUCKET).upload(path, file, { cacheControl: '3600', upsert: true });
            if (error) { console.error("Error al subir archivo a Storage:", error); throw new Error(`Error al subir archivo: ${error.message}`); }
            return data.path;
        }
        function getPublicUrl(path) { /* ... (Sin cambios) ... */ 
            const { data } = supabase.storage.from(ASSETS_BUCKET).getPublicUrl(path); return `${data.publicUrl}?v=${Date.now()}`;
        }
        async function deleteFile(path) { /* ... (Sin cambios) ... */ 
            if (!path || path === 'null') return;
            const { error } = await supabase.storage.from(ASSETS_BUCKET).remove([path]);
            if (error) console.error("Error al eliminar archivo de Storage:", error);
        }
        async function handleLogoUpload(e) { /* ... (Lógica de preview y carga adaptada) ... */ 
             if (!isAdmin) return;
            const file = e.target.files[0]; if (!file) return;
            const logoDiv = document.getElementById('current-logo');
            const reader = new FileReader();
            reader.onload = (event) => {
                 let img = logoDiv.querySelector('img');
                 if (!img) {
                     logoDiv.innerHTML = ''; 
                     img = document.createElement('img');
                     img.className = "w-full h-full object-cover rounded-full"; 
                     logoDiv.appendChild(img);
                 }
                 img.src = event.target.result;
                 if (logoUploadOverlayHTML && !logoDiv.querySelector('#logo-upload-overlay')) {
                     logoDiv.insertAdjacentHTML('beforeend', logoUploadOverlayHTML);
                     const newLogoInput = document.getElementById('logo-file-input');
                     if (newLogoInput) newLogoInput.onchange = handleLogoUpload;
                     lucide.createIcons(); 
                 }
            };
            reader.readAsDataURL(file);

            logoDiv.insertAdjacentHTML('beforeend', '<div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div>');
            try {
                if (!userId) throw new Error("Admin debe iniciar sesión.");
                const path = await uploadFile(file, `logo/${userId}/${Date.now()}_${file.name}`);
                const url = getPublicUrl(path);
                const { error: dbError } = await supabase.from('services').upsert({ id: 'logo', image_url: url, image_path: path, user_id: userId }, { onConflict: 'id' });
                if (dbError) throw dbError;
                displayMessage('Logo actualizado.', authMessage, 'success');
            } catch (error) { 
                console.error("Error al subir logo:", error); displayMessage(`Error al subir logo: ${error.message}`, authMessage, 'error'); loadLogo(); 
            } finally { 
                const loadingIndicator = logoDiv.querySelector('.animate-spin');
                if (loadingIndicator) loadingIndicator.parentElement.remove();
                 if (logoUploadOverlayHTML && !logoDiv.querySelector('#logo-upload-overlay')) {
                     logoDiv.insertAdjacentHTML('beforeend', logoUploadOverlayHTML);
                     const newLogoInput = document.getElementById('logo-file-input');
                      if (newLogoInput) newLogoInput.onchange = handleLogoUpload;
                      lucide.createIcons();
                 }
                e.target.value = null; 
            }
        }
        async function loadLogo() { /* ... (Lógica de carga adaptada) ... */ 
             if (!supabase) return;
            try {
                const { data, error } = await supabase.from('services').select('image_url').eq('id', 'logo').maybeSingle();
                if (error && error.code !== 'PGRST116') throw error;
                const logoDiv = document.getElementById('current-logo');
                logoDiv.innerHTML = ''; 
                if (data && data.image_url) {
                     logoDiv.innerHTML = `<img src="${data.image_url}" class="w-full h-full object-cover rounded-full" onerror="this.onerror=null; this.parentElement.innerHTML = '${defaultSvgHtml.replace(/'/g, "\\'")}' + '${logoUploadOverlayHTML.replace(/'/g, "\\'")}'; lucide.createIcons();">${logoUploadOverlayHTML}`;
                } else {
                    logoDiv.innerHTML = defaultSvgHtml + logoUploadOverlayHTML;
                }
                const logoInput = document.getElementById('logo-file-input');
                if (logoInput) logoInput.onchange = handleLogoUpload;
                if(isAdmin) { logoContainer.classList.add('admin-active'); } 
                else { logoContainer.classList.remove('admin-active'); }
                 lucide.createIcons(); 
            } catch (error) { 
                console.error("Error al cargar logo:", error); 
                const logoDiv = document.getElementById('current-logo'); 
                if(logoDiv) {
                     logoDiv.innerHTML = defaultSvgHtml + logoUploadOverlayHTML; 
                     const logoInput = document.getElementById('logo-file-input');
                     if (logoInput) logoInput.onchange = handleLogoUpload;
                     lucide.createIcons();
                }
            }
        }

        // --- INVENTARIO ---
        function loadInventoryData() { /* ... (Sin cambios) ... */ 
            if (!supabase) return;
            supabase.from('inventory').select('*').order('name', { ascending: true })
                .then(({ data, error }) => { if (error) throw error; renderInventory(data || []); })
                .catch(err => { console.error("Error al cargar inventario:", err); inventoryList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Error al cargar inventario.</td></tr>'; /* ... (Manejo de errores) ... */ });
        }
        function renderInventory(items) { /* ... (Sin cambios) ... */ 
            inventoryList.innerHTML = '';
            if (items.length === 0) { inventoryList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 italic">No hay productos en el inventario.</td></tr>'; return; }
            items.forEach(item => {
                const tr = document.createElement('tr'); tr.className = 'hover:bg-gray-700 transition duration-150';
                const adminButtons = isAdmin ? `<button onclick="toggleInventoryEdit(event, '${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${(item.category || '').replace(/'/g, "\\'")}')" class="edit-btn text-yellow-400 hover:text-yellow-300 p-2 rounded-full transition duration-150" data-editing="false"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteInventoryItem('${item.id}', '${item.image_path}')" class="text-red-500 hover:text-red-400 p-2 rounded-full transition duration-150"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : '';
                tr.innerHTML = `<td class="p-2 align-top">${item.image_url ? `<img src="${item.image_url}" alt="${item.name}" class="inventory-image-preview">` : `<div class="w-full h-[160px] bg-gray-600 rounded-lg flex items-center justify-center text-xs text-gray-400">Sin Foto</div>`}</td><td class="px-4 py-3 align-top font-medium text-white"><span id="inv-name-${item.id}">${item.name}</span></td><td class="px-4 py-3 align-top text-gray-300"><span id="inv-category-${item.id}">${item.category || 'N/A'}</span></td><td class="px-4 py-3 align-top text-white"><span id="inv-price-${item.id}">$${Number(item.price || 0).toFixed(2)}</span></td><td class="px-4 py-3 align-top text-right space-x-2">${adminButtons}</td>`;
                inventoryList.appendChild(tr);
            });
            lucide.createIcons();
        }
        async function addInventoryItem() { /* ... (Sin cambios) ... */ 
             if (!isAdmin || !userId) { displayMessage("Acción no permitida.", inventoryMessage); return; }
            const name = inventoryNameInput.value.trim(); const price = parseFloat(inventoryPriceInput.value.trim()); const category = inventoryCategorySelect.value; const file = inventoryImageFile.files[0];
            if (!name || isNaN(price) || price <= 0 || !category) { displayMessage("Nombre, precio válido y categoría son requeridos.", inventoryMessage); return; }
            inventoryAddBtn.disabled = true; inventoryAddBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Guardando...'; lucide.createIcons();
            let imagePath = null; let imageUrl = null;
            try {
                if (file) { imagePath = await uploadFile(file, `inventory/${userId}/${Date.now()}_${file.name}`); imageUrl = getPublicUrl(imagePath); }
                const { error } = await supabase.from('inventory').insert([{ name, price, category, image_url: imageUrl, image_path: imagePath, user_id: userId }]); if (error) throw error;
                inventoryNameInput.value = ''; inventoryPriceInput.value = ''; inventoryCategorySelect.value = ''; inventoryImageFile.value = '';
                displayMessage('Producto añadido.', inventoryMessage, 'success'); loadInventoryData();
            } catch (e) { console.error("Error al agregar inventario:", e); displayMessage(`Error: ${e.message}`, inventoryMessage); if (imagePath) deleteFile(imagePath);
            } finally { inventoryAddBtn.innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2"></i> Añadir Producto'; inventoryAddBtn.disabled = false; lucide.createIcons(); }
        }
        window.toggleInventoryEdit = function(event, id, currentName, currentPrice, currentCategory) { /* ... (Sin cambios) ... */ 
             if (!isAdmin) return;
            const button = event.currentTarget; const isEditing = button.getAttribute('data-editing') === 'true';
            const nameSpan = document.getElementById(`inv-name-${id}`); const priceSpan = document.getElementById(`inv-price-${id}`); const categorySpan = document.getElementById(`inv-category-${id}`);
            if (!isEditing) {
                nameSpan.innerHTML = `<input type="text" id="input-inv-name-${id}" value="${currentName}" class="w-full bg-gray-600 rounded-md p-1 input-dark" />`;
                priceSpan.innerHTML = `<input type="number" id="input-inv-price-${id}" value="${Number(currentPrice).toFixed(2)}" class="w-full bg-gray-600 rounded-md p-1 input-dark" step="0.01" />`;
                categorySpan.innerHTML = `<select id="input-inv-category-${id}" class="w-full bg-gray-600 rounded-md p-1 input-dark">${CATEGORY_OPTIONS_HTML}</select>`;
                document.getElementById(`input-inv-category-${id}`).value = currentCategory; 
                button.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i>'; button.classList.remove('text-yellow-400'); button.classList.add('text-green-500'); button.setAttribute('data-editing', 'true'); lucide.createIcons();
            } else {
                const newName = document.getElementById(`input-inv-name-${id}`).value.trim(); const newPrice = parseFloat(document.getElementById(`input-inv-price-${id}`).value.trim()); const newCategory = document.getElementById(`input-inv-category-${id}`).value;
                if (!newName || isNaN(newPrice) || newPrice <= 0 || !newCategory) { displayMessage("Nombre, precio y categoría válidos.", inventoryMessage); return; }
                updateInventoryItem(id, newName, newPrice, newCategory);
            }
        }
        async function updateInventoryItem(id, newName, newPrice, newCategory) { /* ... (Sin cambios) ... */ 
            if (!isAdmin) return;
            const { error } = await supabase.from('inventory').update({ name: newName, price: newPrice, category: newCategory, user_id: userId }).eq('id', id);
            if (error) { console.error("Error al actualizar inventario:", error); displayMessage('Error al actualizar.', inventoryMessage); }
            loadInventoryData();
        }
        window.deleteInventoryItem = async function(id, imagePath) { /* ... (Sin cambios) ... */ 
            if (!isAdmin || !confirm("¿Eliminar este producto del inventario?")) return;
            try {
                await deleteFile(imagePath);
                const { error } = await supabase.from('inventory').delete().eq('id', id); if (error) throw error;
                displayMessage('Producto eliminado.', inventoryMessage, 'success'); loadInventoryData();
            } catch (e) { console.error("Error al eliminar inventario:", e); displayMessage(`Error: ${e.message}`, inventoryMessage); }
        }

        // --- VENTAS ---
        function loadSalesData() { /* ... (Sin cambios) ... */ 
            if (!supabase || !userId) { renderSales([]); return; }
            supabase.from('sales').select('*').order('created_at', { ascending: false })
                .then(({ data, error }) => { if (error) throw error; renderSales(data || []); })
                .catch(err => { console.error("Error al cargar ventas:", err.message); salesList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Error al cargar ventas.</td></tr>'; /* ... (Manejo de errores) ... */ });
        }
        function renderSales(items) { /* ... (Sin cambios) ... */ 
            salesList.innerHTML = ''; let total = 0;
            if (items.length === 0) { salesList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 italic">No hay ventas registradas.</td></tr>'; salesTotal.textContent = '$0.00'; return; }
            items.forEach(item => {
                total += Number(item.price || 0); const tr = document.createElement('tr'); tr.className = 'hover:bg-gray-700 transition duration-150';
                const adminButtons = isAdmin ? `<button onclick="toggleSaleEdit(event, '${item.id}', '${(item.clientName || '').replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${(item.category || '').replace(/'/g, "\\'")}')" class="edit-btn text-yellow-400 hover:text-yellow-300 p-2 rounded-full transition duration-150" data-editing="false"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteSaleItem('${item.id}')" class="text-red-500 hover:text-red-400 p-2 rounded-full transition duration-150"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : '';
                tr.innerHTML = `<td class="px-4 py-3 font-medium text-gray-300"><span id="client-name-${item.id}">${item.clientName || 'N/A'}</span></td><td class="px-4 py-3 font-medium text-white"><span id="sale-name-${item.id}">${item.name}</span></td><td class="px-4 py-3 align-top text-gray-300"><span id="sale-category-${item.id}">${item.category || 'N/A'}</span></td><td class="px-4 py-3 text-white"><span id="sale-price-${item.id}">$${Number(item.price || 0).toFixed(2)}</span></td><td class="px-4 py-3 text-right space-x-2">${adminButtons}</td>`;
                salesList.appendChild(tr);
            });
            salesTotal.textContent = `$${total.toFixed(2)}`; lucide.createIcons();
        }
        async function addSaleItem() { /* ... (Sin cambios) ... */ 
             if (!isAdmin || !userId) { salesAuthMessage.textContent = 'Solo el admin puede registrar ventas.'; salesAuthMessage.classList.remove('hidden'); return; }
            const clientName = clientNameInput.value.trim() || 'Venta General'; const name = productNameInput.value.trim(); const price = parseFloat(productPriceInput.value.trim()); const category = saleCategorySelect.value;
            if (!name || isNaN(price) || price <= 0 || !category) { displayMessage("Nombre, precio válido y categoría requeridos.", salesAuthMessage); return; }
            addSaleBtn.disabled = true; addSaleBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Añadiendo...'; lucide.createIcons();
            try {
                const { error } = await supabase.from('sales').insert([{ clientName, name, price, category, user_id: userId, created_at: new Date().toISOString() }]); if (error) throw error;
                productNameInput.value = ''; productPriceInput.value = ''; saleCategorySelect.value = ''; clientNameInput.value = ''; loadSalesData();
            } catch (e) { console.error("Error al agregar venta:", e); displayMessage(`Error: ${e.message}`, salesAuthMessage);
            } finally { addSaleBtn.disabled = false; addSaleBtn.innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2"></i> Añadir a Venta'; lucide.createIcons(); }
        }
        window.toggleSaleEdit = function(event, id, currentClientName, currentName, currentPrice, currentCategory) { /* ... (Sin cambios) ... */ 
            if (!isAdmin) return;
            const button = event.currentTarget; const isEditing = button.getAttribute('data-editing') === 'true';
            const clientSpan = document.getElementById(`client-name-${id}`); const nameSpan = document.getElementById(`sale-name-${id}`); const priceSpan = document.getElementById(`sale-price-${id}`); const categorySpan = document.getElementById(`sale-category-${id}`);
            if (!isEditing) {
                clientSpan.innerHTML = `<input type="text" id="input-client-${id}" value="${currentClientName}" class="w-full bg-gray-600 rounded-md p-1 input-dark" />`; nameSpan.innerHTML = `<input type="text" id="input-sale-name-${id}" value="${currentName}" class="w-full bg-gray-600 rounded-md p-1 input-dark" />`; priceSpan.innerHTML = `<input type="number" id="input-sale-price-${id}" value="${Number(currentPrice).toFixed(2)}" class="w-full bg-gray-600 rounded-md p-1 input-dark" step="0.01" />`; categorySpan.innerHTML = `<select id="input-sale-category-${id}" class="w-full bg-gray-600 rounded-md p-1 input-dark">${CATEGORY_OPTIONS_HTML}</select>`;
                document.getElementById(`input-sale-category-${id}`).value = currentCategory; 
                button.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i>'; button.classList.remove('text-yellow-400'); button.classList.add('text-green-500'); button.setAttribute('data-editing', 'true'); lucide.createIcons();
            } else {
                const newClientName = document.getElementById(`input-client-${id}`).value.trim() || 'Venta General'; const newName = document.getElementById(`input-sale-name-${id}`).value.trim(); const newPrice = parseFloat(document.getElementById(`input-sale-price-${id}`).value.trim()); const newCategory = document.getElementById(`input-sale-category-${id}`).value;
                if (!newName || isNaN(newPrice) || newPrice <= 0 || !newCategory) { displayMessage("Nombre, precio y categoría válidos.", salesAuthMessage); return; }
                updateSaleItem(id, newClientName, newName, newPrice, newCategory);
            }
        }
        async function updateSaleItem(id, newClientName, newName, newPrice, newCategory) { /* ... (Sin cambios) ... */ 
            if (!isAdmin) return;
            const { error } = await supabase.from('sales').update({ clientName: newClientName, name: newName, price: newPrice, category: newCategory }).eq('id', id);
            if (error) { console.error("Error al actualizar venta:", error); displayMessage('Error al actualizar.', salesAuthMessage); }
             loadSalesData();
        }
        window.deleteSaleItem = async function(id) { /* ... (Sin cambios) ... */ 
             if (!isAdmin || !confirm("¿Eliminar esta venta del registro?")) return;
            const { error } = await supabase.from('sales').delete().eq('id', id);
            if (error) { console.error("Error al eliminar venta:", error); displayMessage(`Error: ${error.message}`, salesAuthMessage); } else { loadSalesData(); }
        }

        // --- MODALES Y EVENT LISTENERS ---
        function openModal(modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeModal(modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        document.querySelectorAll('.fixed.inset-0').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }); });
        document.getElementById('open-auth-modal-btn').onclick = () => openModal(authModal);
        document.getElementById('close-auth-modal').onclick = () => closeModal(authModal);
        logoutBtn.onclick = handleLogout;
        toggleAuthModeBtn.onclick = () => { const isLogin = authTitle.textContent === 'Iniciar Sesión'; authTitle.textContent = isLogin ? 'Registrarse' : 'Iniciar Sesión'; authButtonText.textContent = isLogin ? 'Registrarse' : 'Iniciar Sesión'; toggleAuthModeBtn.textContent = isLogin ? '¿Ya tienes cuenta? Inicia Sesión' : '¿No tienes cuenta? Regístrate'; };
        loginForm.onsubmit = handleAuthSubmit;
        document.getElementById('open-inventory-modal-btn').onclick = () => openModal(inventoryModal);
        document.getElementById('close-inventory-modal').onclick = () => closeModal(inventoryModal);
        inventoryAddBtn.onclick = addInventoryItem;
        openSalesModalBtn.onclick = () => { if (userId) { salesAuthMessage.classList.add('hidden'); salesContent.classList.remove('hidden'); openModal(salesModal); } else { salesAuthMessage.textContent = 'Debes iniciar sesión para acceder a las ventas.'; salesAuthMessage.classList.remove('hidden'); salesContent.classList.add('hidden'); openModal(salesModal); } };
        document.getElementById('close-sales-modal').onclick = () => closeModal(salesModal);
        addSaleBtn.onclick = addSaleItem;
        if(openThemeDropdownBtn) { openThemeDropdownBtn.onclick = (e) => { e.stopPropagation(); themeDropdownMenu.classList.toggle('hidden'); }; }
        window.addEventListener('click', (e) => { if (themeDropdownWrapper && !themeDropdownWrapper.contains(e.target)) { closeThemeDropdown(); } });

        // --- INICIALIZACIÓN ---
        async function initSupabaseAndSession() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { handleGlobalError('¡ERROR: Faltan la URL o la Clave de Supabase!'); return; }
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) { console.error("Error al obtener la sesión inicial:", sessionError.message); handleAuthChange(null); } 
                else { handleAuthChange(session); }

                supabase.auth.onAuthStateChange((event, session) => {
                    console.log(`Evento de Auth detectado: ${event}`);
                    // ==================================================
                    // CORRECCIÓN AQUÍ: Solo llamar en SIGNED_IN y SIGNED_OUT
                    // ==================================================
                    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                        handleAuthChange(session);
                    }
                    // Para otros eventos como TOKEN_REFRESHED, USER_UPDATED, etc.,
                    // Supabase maneja la sesión internamente. No necesitamos recargar todo.
                });

            } catch (e) { console.error("Error crítico al inicializar Supabase:", e); handleGlobalError('Error al inicializar Supabase.'); }
        }
        
        window.onload = async function() {
            initLogoTemplates(); 
            loadSavedTheme();   
            await initSupabaseAndSession(); 
        };
    </script>
</body>
</html>
